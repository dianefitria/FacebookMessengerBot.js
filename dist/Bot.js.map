{"version":3,"sources":["../src/Bot.js"],"names":["time","setTimeout","resolve","wait","Elements","Buttons","QuickReplies","userCache","Bot","token","verification","debug","_token","_debug","_verification","text","method","json","query","access_token","body","setting_type","greeting","result","input","thread_state","data","event","call_to_actions","payload","to","state","action","recipient","id","sender_action","message","notification_type","console","log","toJSON","err","JSON","parse","error","type","ee","Error","fields","cache","key","props","fromCache","entry","standby","delivery","mids","emit","messaging","raw","sender","fetch","fetchUser","postback","e","isButton","hasOwnProperty","delivered","optin","param","ref","quick_reply","is_echo","isQuickReply","attachments","groupBy","image","images","map","a","url","video","videos","audio","location","coordinates","object","router","use","get","req","res","send","post","handleStandby","handleMessage","status"],"mappings":"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","file":"Bot.js","sourcesContent":["import EventEmitter from 'events';\nimport bodyParser from 'body-parser';\nimport { Router } from 'express';\nimport Elements from './Elements.js';\nimport Buttons from './Buttons.js';\nimport QuickReplies from './QuickReplies.js';\nimport fetch from './libs/fetch.js';\nimport _ from 'lodash';\n\nexport { Elements, Buttons, QuickReplies };\n\nconst userCache = {};\n\nexport async function wait(time) {\n  return new Promise(resolve => setTimeout(() => resolve(), time));\n}\n\nclass Bot extends EventEmitter {\n  static Buttons = Buttons;\n  static Elements = Elements;\n\n  static wait = wait;\n\n  constructor(token, verification, debug = false) {\n    super();\n\n    this._token = token;\n    this._debug = debug;\n    this._verification = verification;\n  }\n\n  async setGreeting(text) {\n    const { body: { result } } = await fetch('https://graph.facebook.com/v2.6/me/thread_settings', {\n      method: 'post',\n      json: true,\n      query: { access_token: this._token },\n      body: { setting_type: 'greeting', greeting: { text } }\n    });\n\n    return result;\n  }\n\n  async setGetStarted(input) {\n    if (!input) {\n      const { body: { result } } = await fetch('https://graph.facebook.com/v2.6/me/thread_settings', {\n        method: 'delete',\n        json: true,\n        query: { access_token: this._token },\n        body: {\n          setting_type: 'call_to_actions',\n          thread_state: 'new_thread'\n        }\n      });\n\n      return result;\n    }\n\n    const { data, event } = input;\n    const { body: { result } } = await fetch('https://graph.facebook.com/v2.6/me/thread_settings', {\n      method: 'post',\n      json: true,\n      query: { access_token: this._token },\n      body: {\n        setting_type: 'call_to_actions',\n        thread_state: 'new_thread',\n        call_to_actions: [{ payload: JSON.stringify({ data, event }) }]\n      }\n    });\n\n    return result;\n  }\n\n  async setPersistentMenu(input) {\n    if (!input) {\n      const { body: { result } } = await fetch('https://graph.facebook.com/v2.6/me/thread_settings', {\n        method: 'delete',\n        json: true,\n        query: { access_token: this._token },\n        body: {\n          setting_type: 'call_to_actions',\n          thread_state: 'existing_thread'\n        }\n      });\n\n      return result;\n    }\n\n    const { body: { result } } = await fetch('https://graph.facebook.com/v2.6/me/thread_settings', {\n      method: 'post',\n      json: true,\n      query: { access_token: this._token },\n      body: {\n        setting_type: 'call_to_actions',\n        thread_state: 'existing_thread',\n        call_to_actions: input\n      }\n    });\n\n    return result;\n  }\n\n  async setTyping(to, state) {\n    const action = state ? 'typing_on' : 'typing_off';\n\n    const { body: { result } } = await fetch('https://graph.facebook.com/v2.6/me/messages', {\n      method: 'post',\n      json: true,\n      query: { access_token: this._token },\n      body: { recipient: { id: to }, sender_action: action }\n    });\n\n    return result;\n  }\n\n\n  async send(to, message, notification_type = \"REGULAR\") {\n    if (this._debug) {\n      console.log({ recipient: { id: to }, message: message ? message.toJSON() : message, notification_type });\n    }\n\n    try {\n      await fetch('https://graph.facebook.com/v2.6/me/messages', {\n        method: 'post',\n        json: true,\n        query: { access_token: this._token },\n        body: { recipient: { id: to }, message, notification_type }\n      });\n    } catch (e) {\n      if (e.text) {\n        let text = e.text;\n        try {\n          const err = JSON.parse(e.text).error;\n          text = `${err.type || 'Unknown'}: ${err.message || 'No message'}`;\n        } catch (ee) {\n          // ignore\n        }\n\n        throw Error(text);\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  async fetchUser(id, fields = 'first_name,last_name,profile_pic', cache = false) {\n    const key = id + fields;\n    let props;\n\n    if (cache && userCache[key]) {\n      props = userCache[key];\n      props.fromCache = true;\n    } else {\n      const { body } = await fetch(`https://graph.facebook.com/v2.6/${id}`, {\n        query: { access_token: this._token, fields }, json: true\n      });\n\n      props = body;\n      props.fromCache = false;\n\n      if (cache) {\n        userCache[key] = props;\n      }\n    }\n\n    return props;\n  }\n\n  async handleStandby(input) {\n    const body = JSON.parse(JSON.stringify(input));\n    const message = body.entry[0].standby[0];\n\n    //filter for message_delivered events\n    if (message.delivery && message.delivery.mids && message.delivery.mids[0]){\n      this.emit('standby', message);\n    }\n  }\n\n  async handleMessage(input) {\n    const body = JSON.parse(JSON.stringify(input));\n    const message = body.entry[0].messaging[0];\n    Object.assign(message, message.message);\n    delete message.message;\n\n    message.raw = input;\n\n    message.sender.fetch = async (fields, cache) => {\n      const props = await this.fetchUser(message.sender.id, fields, cache);\n      Object.assign(message.sender, props);\n      return message.sender;\n    };\n\n    // POSTBACK\n    if (message.postback) {\n      let postback = {};\n\n      try {\n        postback = JSON.parse(message.postback.payload) || {};\n      } catch (e) {\n        // ignore\n      }\n      message.isButton = true;\n\n      if (postback.hasOwnProperty('data')) {\n        //message.postback = postback;\n        message.data = postback.data;\n        message.event = postback.event;\n\n        this.emit('postback', message.event, message, message.data);\n\n        if (postback.hasOwnProperty('event')) {\n          this.emit(message.event, message, message.data);\n        }\n      } else {\n        this.emit('invalid-postback', message, message.postback);\n      }\n\n      return;\n    }\n\n    // DELIVERY\n    if (message.delivery) {\n      Object.assign(message, message.delivery);\n      message.delivered = message.delivery.mids;\n\n      delete message.delivery;\n\n      this.emit('delivery', message, message.delivered);\n      return;\n    }\n\n    // OPTIN\n    if (message.optin) {\n      message.param = message.optin.ref || true;\n      message.optin = message.param;\n      this.emit('optin', message, message.optin);\n      return;\n    }\n\n    // QUICK_REPLY\n    if (message.quick_reply && !message.is_echo) {\n      let postback = {};\n\n      try {\n        postback = JSON.parse(message.quick_reply.payload) || {};\n      } catch (e) {\n        // ignore\n      }\n\n      message.isQuickReply = true;\n\n      if (postback.hasOwnProperty('data')) {\n        message.postback = postback;\n        message.data = postback.data;\n        message.event = postback.event;\n\n        this.emit('postback', message.event, message, message.data);\n\n        if (postback.hasOwnProperty('event')) {\n          this.emit(message.event, message, message.data);\n        }\n      } else {\n        this.emit('invalid-postback', message, message.postback);\n      }\n\n      return;\n    }\n\n    const attachments = _.groupBy(message.attachments, 'type');\n\n    if (attachments.image) {\n      message.images = attachments.image.map(a => a.payload.url);\n    }\n\n    if (attachments.video) {\n      message.videos = attachments.video.map(a => a.payload.url);\n    }\n\n    if (attachments.audio) {\n      message.audio = attachments.audio.map(a => a.payload.url)[0];\n    }\n\n    if (attachments.location) {\n      const location = attachments.location[0];\n      message.location = { ...location, ...location.payload.coordinates };\n      delete message.location.payload;\n    }\n\n    message.object = body.object;\n\n    delete message.attachments;\n\n    this.emit('message', message);\n  }\n\n  router() {\n    const router = new Router();\n\n    router.use(bodyParser.json());\n\n    router.get('/', (req, res) => {\n      if (req.query['hub.verify_token'] === this._verification) {\n        res.send(req.query['hub.challenge']);\n      } else {\n        res.send('Error, wrong validation token');\n      }\n    });\n\n    router.post('/', (req, res) => {\n      if (req.body.entry[0].standby) {\n        this.handleStandby(req.body);\n      } else {\n        this.handleMessage(req.body);\n      }\n      res.send().status(200);\n    });\n\n    return router;\n  }\n}\n\nexport { Bot };\n\nexport default Bot;\n"]}